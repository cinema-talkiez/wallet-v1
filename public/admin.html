<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
    body{background:linear-gradient(135deg,#dc3545,#ff6b6b);min-height:100vh;color:#333}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .profile-card{background:white;padding:30px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.2);margin-bottom:30px;text-align:center}
    .profile-card h2{margin-bottom:15px;color:#dc3545;font-size:28px}
    .input-group{margin-bottom:20px;text-align:left}
    .input-group label{display:block;margin-bottom:8px;font-weight:600;color:#555}
    .input-group input{width:100%;padding:14px;border:1px solid #ddd;border-radius:8px;font-size:16px}
    button{padding:14px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:0.3s}
    .earn-btn{background:#28a745;color:white;width:100%;font-size:18px}
    .earn-btn:hover{background:#218838}
    .search-bar{margin:25px 0;text-align:center}
    .search-bar input{width:100%;max-width:600px;padding:14px;border:1px solid #ddd;border-radius:8px;font-size:16px}
    .tabs{display:flex;gap:10px;margin:20px 0;justify-content:center;flex-wrap:wrap}
    .tab-btn{padding:12px 20px;background:rgba(255,255,255,0.9);border:none;border-radius:8px;font-weight:600;cursor:pointer}
    .tab-btn.active,.tab-btn:hover{background:white;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .admin-section{margin:40px 0}
    .admin-section h3{color:white;font-size:24px;text-align:center;margin-bottom:20px;text-shadow:0 2px 4px rgba(0,0,0,0.2)}
    .table-container{overflow-x:auto;background:white;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.15)}
    table{width:100%;border-collapse:collapse;font-size:15px}
    th,td{padding:14px 16px;text-align:left;border-bottom:1px solid #eee}
    th{background:#f8f9fa;font-weight:600;color:#333}
    tr:hover{background:#f1f3f5}
    .status{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:bold;text-transform:uppercase}
    .status-pending{background:#fff3cd;color:#856404}
    .status-success{background:#d4edda;color:#155724}
    .status-rejected{background:#f8d7da;color:#721c24}
    .action-btn{padding:6px 12px;margin:0 4px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer}
    .approve-btn{background:#28a745;color:white}
    .reject-btn{background:#dc3545;color:white}
    .pagination{display:flex;justify-content:center;gap:12px;align-items:center;margin:20px 0;font-weight:600}
    .page-btn{padding:8px 14px;background:rgba(255,255,255,0.9);border:none;border-radius:8px;cursor:pointer}
    .page-btn:hover,.page-btn.active{background:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    .page-btn:disabled{opacity:0.4;cursor:not-allowed}
    .ellipsis{color:white;font-size:18px}
    .empty-msg{text-align:center;color:white;font-style:italic;margin:20px 0}
    @media(max-width:768px){
      .action-btn{display:block;width:100%;margin:5px 0}
      th,td{font-size:14px;padding:10px}
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Login -->
    <div id="admin-login" class="profile-card">
      <h2>Admin Login</h2>
      <form id="admin-form">
        <div class="input-group"><label>Email</label><input type="email" id="admin-email" value="admin@earnapp.com" required /></div>
        <div class="input-group"><label>Password</label><input type="password" id="admin-password" required /></div>
        <button type="submit" class="earn-btn">Login</button>
      </form>
      <p id="login-error" style="color:red;margin-top:15px;display:none;font-weight:bold;"></p>
    </div>

    <!-- Dashboard -->
    <div id="admin-panel" style="display:none;">
      <div class="profile-card"><h2>Admin Dashboard</h2><p>All: 10 per page | &lt; [1]...[Last] &gt;</p></div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="pending">Pending</button>
        <button class="tab-btn" data-tab="approved">Approved</button>
        <button class="tab-btn" data-tab="rejected">Rejected</button>
        <button class="tab-btn" data-tab="users">Users</button>
      </div>

      <div class="search-bar"><input type="text" id="global-search" placeholder="Search name, email, UPI..." /></div>

      <!-- PENDING -->
      <div id="pending" class="tab-content active">
        <div class="admin-section">
          <h3>Pending Requests</h3>
          <div class="table-container">
            <table id="pending-table">
              <thead><tr><th>User</th><th>Amount</th><th>UPI</th><th>Requested</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="pending-empty" class="empty-msg" style="display:none;">No pending requests.</div>
          <div class="pagination" id="pending-pagination"></div>
        </div>
      </div>

      <!-- APPROVED -->
      <div id="approved" class="tab-content">
        <div class="admin-section">
          <h3>Approved</h3>
          <div class="table-container">
            <table id="approved-table">
              <thead><tr><th>User</th><th>Amount</th><th>UPI</th><th>Approved At</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="approved-empty" class="empty-msg" style="display:none;">No approved requests.</div>
          <div class="pagination" id="approved-pagination"></div>
        </div>
      </div>

      <!-- REJECTED -->
      <div id="rejected" class="tab-content">
        <div class="admin-section">
          <h3>Rejected</h3>
          <div class="table-container">
            <table id="rejected-table">
              <thead><tr><th>User</th><th>Amount</th><th>UPI</th><th>Rejected At</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="rejected-empty" class="empty-msg" style="display:none;">No rejected requests.</div>
          <div class="pagination" id="rejected-pagination"></div>
        </div>
      </div>

      <!-- USERS -->
      <div id="users" class="tab-content">
        <div class="admin-section">
          <h3>All Users</h3>
          <div class="table-container">
            <table id="users-table">
              <thead><tr><th>Name</th><th>UserID</th><th>Email</th><th>Wallet</th><th>Joined</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="users-empty" class="empty-msg" style="display:none;">No users.</div>
          <div class="pagination" id="users-pagination"></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const d = id => document.getElementById(id);
    let token = localStorage.getItem('adminToken');
    let data = { pending: [], approved: [], rejected: [], users: [] };
    const perPage = 10;
    const pages = { pending: 1, approved: 1, rejected: 1, users: 1 };

    const show = mode => {
      d('admin-login').style.display = mode === 'login' ? 'block' : 'none';
      d('admin-panel').style.display = mode === 'panel' ? 'block' : 'none';
    };

    const load = async () => {
      if (!token) return show('login');
      show('panel');
      await loadAll();
    };

    d('admin-form').onsubmit = async e => {
      e.preventDefault();
      const res = await fetch('/.netlify/functions/admin-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: d('admin-email').value, password: d('admin-password').value })
      });
      const resData = await res.json();
      if (resData.success) {
        localStorage.setItem('adminToken', resData.token);
        token = resData.token;
        load();
      } else {
        d('login-error').textContent = resData.msg || 'Login failed';
        d('login-error').style.display = 'block';
      }
    };

    const loadAll = async () => {
      const [reqRes, userRes] = await Promise.all([
        fetch('/.netlify/functions/admin-get-requests', { headers: { Authorization: `Bearer ${token}` } }),
        fetch('/.netlify/functions/admin-get-users', { headers: { Authorization: `Bearer ${token}` } })
      ]);
      const reqData = await reqRes.json();
      const userData = await userRes.json();

      data.pending = [];
      data.approved = [];
      data.rejected = [];
      (reqData.requests || []).forEach(r => {
        if (r.status === 'pending') data.pending.push(r);
        else if (r.status === 'success') data.approved.push(r);
        else if (r.status === 'rejected') data.rejected.push(r);
      });
      data.users = userData.users || [];

      renderAll();
    };

    const renderSection = (type) => {
      const list = data[type];
      const page = pages[type];
      const total = Math.ceil(list.length / perPage);
      if (total === 0) {
        d(`${type}-empty`).style.display = 'block';
        d(`${type}-pagination`).innerHTML = '';
        d(`${type}-table`).querySelector('tbody').innerHTML = '';
        return;
      }
      d(`${type}-empty`).style.display = 'none';

      const start = (page - 1) * perPage;
      const end = start + perPage;
      const pageData = list.slice(start, end);

      const tbody = d(`${type}-table`).querySelector('tbody');
      tbody.innerHTML = '';
      pageData.forEach(r => {
        const tr = document.createElement('tr');
        if (type === 'pending') {
          tr.innerHTML = `
            <td><strong>${r.user?.name||'N/A'}</strong><br><small>${r.user?.userid||''}</small></td>
            <td>$${r.amount}</td>
            <td>${r.upiId}</td>
            <td>${new Date(r.requestedAt).toLocaleString()}</td>
            <td>
              <button class="action-btn approve-btn" data-id="${r._id}">Approve</button>
              <button class="action-btn reject-btn" data-id="${r._id}">Reject</button>
            </td>
          `;
        } else if (type === 'approved') {
          tr.innerHTML = `
            <td><strong>${r.user?.name||'N/A'}</strong><br><small>${r.user?.userid||''}</small></td>
            <td>$${r.amount}</td>
            <td>${r.upiId}</td>
            <td>${new Date(r.approvedAt || r.updatedAt).toLocaleString()}</td>
          `;
        } else if (type === 'rejected') {
          tr.innerHTML = `
            <td><strong>${r.user?.name||'N/A'}</strong><br><small>${r.user?.userid||''}</small></td>
            <td>$${r.amount}</td>
            <td>${r.upiId}</td>
            <td>${new Date(r.rejectedAt || r.updatedAt).toLocaleString()}</td>
          `;
        } else if (type === 'users') {
          tr.innerHTML = `<td>${r.name}</td><td>${r.userid}</td><td>${r.email}</td><td>$${r.wallet}</td><td>${new Date(r.createdAt).toLocaleDateString()}</td>`;
        }
        tbody.appendChild(tr);
      });

      // PAGINATION: < [1]......[Last] >
      const pag = d(`${type}-pagination`);
      pag.innerHTML = '';

      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-btn';
      prevBtn.textContent = '<';
      prevBtn.disabled = page === 1;
      prevBtn.onclick = () => { pages[type] = page - 1; renderSection(type); };
      pag.appendChild(prevBtn);

      const firstBtn = document.createElement('button');
      firstBtn.className = 'page-btn';
      firstBtn.textContent = '1';
      firstBtn.className += page === 1 ? ' active' : '';
      firstBtn.onclick = () => { pages[type] = 1; renderSection(type); };
      pag.appendChild(firstBtn);

      if (total > 2) {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'ellipsis';
        ellipsis.textContent = '......';
        pag.appendChild(ellipsis);
      }

      if (total > 1) {
        const lastBtn = document.createElement('button');
        lastBtn.className = 'page-btn';
        lastBtn.textContent = total;
        lastBtn.className += page === total ? ' active' : '';
        lastBtn.onclick = () => { pages[type] = total; renderSection(type); };
        pag.appendChild(lastBtn);
      }

      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-btn';
      nextBtn.textContent = '>';
      nextBtn.disabled = page === total;
      nextBtn.onclick = () => { pages[type] = page + 1; renderSection(type); };
      pag.appendChild(nextBtn);

      if (type === 'pending') setupActions();
    };

    const renderAll = () => {
      ['pending', 'approved', 'rejected', 'users'].forEach(renderSection);
    };

    const setupActions = () => {
      document.querySelectorAll('.approve-btn').forEach(b => {
        b.onclick = async () => {
          await fetch('/.netlify/functions/admin-approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify({ requestId: b.dataset.id })
          });
          await loadAll();
        };
      });
      document.querySelectorAll('.reject-btn').forEach(b => {
        b.onclick = async () => {
          await fetch('/.netlify/functions/admin-reject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
            body: JSON.stringify({ requestId: b.dataset.id })
          });
          await loadAll();
        };
      });
    };

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        d(btn.dataset.tab).classList.add('active');
      };
    });

    // Search
    d('global-search').addEventListener('input', () => {
      const q = d('global-search').value.toLowerCase();
      document.querySelectorAll('tr').forEach(r => {
        r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    load();
  </script>
</body>
</html>